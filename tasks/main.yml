---
- name: Include OS-specific variables.
  ansible.builtin.include_vars: "{{ lookup('ansible.builtin.first_found', params) }}"
  vars:
    params:
      files:
        - "{{ ansible_distribution | lower }}.yml"
        - "{{ ansible_os_family | lower }}.yml"
      paths:
        - vars
  tags:
    - minimal

- name: Include OS-specific tasks
  ansible.builtin.include_tasks: "{{ ansible_os_family | lower }}.yml"
  tags:
    - minimal

- name: Ensure custom profile scripts are present
  ansible.builtin.copy:
    src: "{{ item }}"
    dest: "/etc/profile.d/{{ item }}"
    owner: root
    group: root
    mode: u=rw,g=r,o=r
  loop:
    - myaliases.sh
    - myfunctions.sh
    - myprompt.sh
    - localbin.sh
  tags:
    - minimal

- name: Ensure time zone is configured
  ansible.builtin.include_tasks: timezone.yml
  tags:
    - minimal

- name: Ensure certificate authority is configured
  ansible.builtin.include_tasks: certauth.yml
  tags:
    - minimal
  when: base_certauth | length > 0

- name: Enable syslog logging forwarding rule
  ansible.builtin.include_tasks: syslog.yml
  when: base_logging_rules | length > 0

- name: Include tasks for virtualized guests
  ansible.builtin.include_tasks: hypervisor.yml
  when:
    - ansible_bios_version is match("Hyper-V UEFI") or
      ansible_bios_version is match("VirtualBox") or
      ansible_bios_vendor is match("SeaBIOS") or
      ansible_bios_vendor is match("OVMF")

- name: Ensure additional packages are installed
  ansible.builtin.package:
    name: "{{ item }}"
    state: present
  with_items: "{{ base_additional_packages }}"
  when: base_additional_packages | length > 0
  tags:
    - minimal

- name: Ensure sysctl is configured appropriately
  ansible.builtin.include_tasks: sysctl.yml

- name: Ensure OpenSSH is configured appropriately
  ansible.builtin.include_tasks: ssh.yml

- name: Ensure Sudoers configuration is correct
  ansible.builtin.include_tasks: sudo.yml

- name: Ensure all handlers run before continuing
  ansible.builtin.meta: flush_handlers
